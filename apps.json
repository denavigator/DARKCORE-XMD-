const fs = require("fs");
const settings = require("./settings.js");

// ------------------ CONFIG ------------------
const PREFIX = settings.PREFIX;
const OWNER_NUMBERS = settings.OWNER_NUMBERS;
const BAD_WORDS = settings.BAD_WORDS;
const SESSION_ID = settings.SESSION_ID;
const PHONE_NUMBER = settings.PHONE_NUMBER;

// ------------------ DATABASE ------------------
let db = {
    users: {},
    aiMode: {},
    mutedGroups: {},
    banned: []
};

// Load existing database if exists
if (fs.existsSync("./db.json")) {
    try {
        db = JSON.parse(fs.readFileSync("./db.json"));
    } catch (e) {
        console.error("âŒ Failed to load db.json, starting fresh");
    }
}

// Save database
function saveDB() {
    fs.writeFileSync("./db.json", JSON.stringify(db, null, 2));
}

// ------------------ HELPERS ------------------

// Check if a user is owner
function isOwner(number) {
    return OWNER_NUMBERS.includes(number);
}

// Check if user is premium
function isPremium(user) {
    if (!db.users[user]) return false;
    return db.users[user].premium || false;
}

// Get user XP and level
function getLevelInfo(user) {
    if (!db.users[user]) return { xp: 0, level: 1 };
    return db.users[user];
}

// Check for bad words
function containsBadWord(text) {
    return BAD_WORDS.some(w => text.toLowerCase().includes(w));
}

// Daily reward check
function canClaimDaily(user) {
    if (!db.users[user]) return true;
    const now = new Date();
    const last = db.users[user].lastDaily ? new Date(db.users[user].lastDaily) : null;
    if (last && now - last < 24 * 60 * 60 * 1000) return false;
    return true;
}

// Add XP
function addXP(user, amount = settings.XP_GAIN) {
    if (!db.users[user]) db.users[user] = { xp: 0, level: 1, coins: 0, premium: false, badge: settings.DEFAULT_BADGE, lastDaily: null };
    db.users[user].xp += amount;
    if (db.users[user].xp >= db.users[user].level * settings.LEVEL_MULTIPLIER) {
        db.users[user].level += 1;
        db.users[user].xp = 0;
    }
    saveDB();
}

// Add coins
function addCoins(user, amount = settings.COINS_GAIN) {
    if (!db.users[user]) db.users[user] = { xp: 0, level: 1, coins: 0, premium: false, badge: settings.DEFAULT_BADGE, lastDaily: null };
    db.users[user].coins += amount;
    saveDB();
}

// Claim daily reward
function claimDaily(user) {
    if (!db.users[user]) db.users[user] = { xp: 0, level: 1, coins: 0, premium: false, badge: settings.DEFAULT_BADGE, lastDaily: null };
    const now = new Date();
    const last = db.users[user].lastDaily ? new Date(db.users[user].lastDaily) : null;
    if (last && now - last < 24 * 60 * 60 * 1000) return false;
    db.users[user].coins += settings.DAILY_COINS;
    db.users[user].lastDaily = now.toISOString();
    saveDB();
    return true;
}

// Set premium
function setPremium(user, status = true) {
    if (!db.users[user]) db.users[user] = { xp: 0, level: 1, coins: 0, premium: false, badge: settings.DEFAULT_BADGE, lastDaily: null };
    db.users[user].premium = status;
    saveDB();
}

// Add badge
function addBadge(user, badge) {
    if (!db.users[user]) db.users[user] = { xp: 0, level: 1, coins: 0, premium: false, badge: settings.DEFAULT_BADGE, lastDaily: null };
    db.users[user].badge = badge;
    saveDB();
}

// Export everything
module.exports = {
    PREFIX,
    OWNER_NUMBERS,
    BAD_WORDS,
    SESSION_ID,
    PHONE_NUMBER,
    db,
    saveDB,
    isOwner,
    isPremium,
    getLevelInfo,
    containsBadWord,
    canClaimDaily,
    addXP,
    addCoins,
    claimDaily,
    setPremium,
    addBadge,
    settings
};
